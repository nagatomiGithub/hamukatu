package dao;import java.sql.Connection;import java.sql.PreparedStatement;import java.sql.ResultSet;import java.sql.SQLException;import java.util.ArrayList;import java.util.List;import beans.Article;import beans.MyData;import beans.User;public class Dao extends DriverAccessor {    // --- 1. 記事一覧（検索・トレンド・新着対応） ---    public List<Article> getArticleList(String keyword, boolean isTrend) {        Connection connection = this.createConnection();        List<Article> list = new ArrayList<>();        try {            String sql;            if (keyword != null && !keyword.isBlank()) {                sql = "SELECT * FROM article WHERE title LIKE ? OR body LIKE ? ORDER BY entry_datetime DESC";            } else if (isTrend) {                sql = "SELECT * FROM article ORDER BY fav_count DESC, entry_datetime DESC";            } else {                sql = "SELECT * FROM article ORDER BY entry_datetime DESC";            }            PreparedStatement stmt = connection.prepareStatement(sql);            if (keyword != null && !keyword.isBlank()) {                String q = "%" + keyword + "%";                stmt.setString(1, q); stmt.setString(2, q);            }            ResultSet rs = stmt.executeQuery();            while (rs.next()) {                list.add(new Article(rs.getInt("id"), rs.getString("title"), rs.getString("body"),                    rs.getString("editorId"), rs.getInt("fav_count"), rs.getTimestamp("entry_datetime")));            }        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }        return list;    }    // --- 2. 記事投稿 (EntryArticleServletのエラー 解消用) ---    public void insertArticle(Article article) {        Connection connection = this.createConnection();        try {            String sql = "INSERT INTO article (title, body, editorId) VALUES (?, ?, ?)";            PreparedStatement stmt = connection.prepareStatement(sql);            stmt.setString(1, article.getTitle());            stmt.setString(2, article.getBody());            stmt.setString(3, article.getEditorId());            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }    // --- 3. 記事削除 (DeleteServlet用) ---    public void deleteArticle(int id) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("DELETE FROM article WHERE id = ?");            stmt.setInt(1, id);            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }    // --- 4. いいね機能 (FavoriteServlet用) ---    public void addFavorite(int articleId, String userId) {        Connection connection = this.createConnection();        try {            // 二重いいね防止            String checkSql = "SELECT * FROM favorites WHERE article_id = ? AND user_id = ?";            PreparedStatement checkStmt = connection.prepareStatement(checkSql);            checkStmt.setInt(1, articleId);            checkStmt.setString(2, userId);            if (checkStmt.executeQuery().next()) return;            connection.setAutoCommit(false);            // カウント更新            connection.prepareStatement("UPDATE article SET fav_count = fav_count + 1 WHERE id = " + articleId).executeUpdate();            // 履歴挿入            PreparedStatement insStmt = connection.prepareStatement("INSERT INTO favorites (article_id, user_id) VALUES (?, ?)");            insStmt.setInt(1, articleId);            insStmt.setString(2, userId);            insStmt.executeUpdate();            connection.commit();        } catch (SQLException e) {            try { connection.rollback(); } catch (SQLException ex) {}            e.printStackTrace();        } finally { this.closeConnection(connection); }    }    // --- 5. コメント機能 ---    public void insertComment(int articleId, String userId, String body) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("INSERT INTO comment (article_id, user_id, body) VALUES (?, ?, ?)");            stmt.setInt(1, articleId);            stmt.setString(2, userId);            stmt.setString(3, body);            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }    public List<String> getCommentsByArticleId(int articleId) {        Connection connection = this.createConnection();        List<String> comments = new ArrayList<>();        try {            PreparedStatement stmt = connection.prepareStatement("SELECT body FROM comment WHERE article_id = ? ORDER BY entry_datetime ASC");            stmt.setInt(1, articleId);            ResultSet rs = stmt.executeQuery();            while (rs.next()) {                comments.add(rs.getString("body"));            }        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }        return comments;    }    // --- 6. ユーザー管理 (Login/Entry/Update用) ---    public User getUserById(String id) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("SELECT * FROM user WHERE id = ?");            stmt.setString(1, id);            ResultSet rs = stmt.executeQuery();            if (rs.next()) {                return new User(rs.getString("id"), rs.getString("password"), rs.getString("name"));            }        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }        return null;    }    public void insertUser(User user) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("INSERT INTO user (id, password, name) VALUES (?, ?, ?)");            stmt.setString(1, user.getId());            stmt.setString(2, user.getPassword());            stmt.setString(3, user.getName());            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }    public void updateUser(User user) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("UPDATE user SET password = ?, name = ? WHERE id = ?");            stmt.setString(1, user.getPassword());            stmt.setString(2, user.getName());            stmt.setString(3, user.getId());            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }    // --- 7. 演習用データ (MyDataの引数エラー 解消版) ---    public List<MyData> getMyDataList() {        Connection connection = this.createConnection();        List<MyData> list = new ArrayList<>();        try {            ResultSet rs = connection.prepareStatement("SELECT * FROM my_data ORDER BY id DESC").executeQuery();            while (rs.next()) {                list.add(new MyData(rs.getInt("id"), rs.getString("data")));            }        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }        return list;    }    public void insertMyData(String data) {        Connection connection = this.createConnection();        try {            PreparedStatement stmt = connection.prepareStatement("INSERT INTO my_data (data) VALUES (?)");            stmt.setString(1, data);            stmt.executeUpdate();        } catch (SQLException e) { e.printStackTrace(); } finally { this.closeConnection(connection); }    }}